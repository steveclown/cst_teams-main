<?php	Class pulldataattendance extends CI_Controller{		public function __construct(){			parent::__construct();			$this->load->model('pulldataattendance_model');			$this->load->helper('sistem');			$this->load->library('fungsi');			$this->load->library('configuration');			$this->load->library('zklibs');		}				public function index(){			$this->lists();					}				public function machine_name(){			$page = $this->uri->segment(3);			echo $page;		}				public function filter(){			$data = array (				'machine_id'						=> $this->input->post('machine_id',true),				'start_date'						=> $this->input->post('start_date',true),				'end_date'						=> $this->input->post('end_date',true),				'options'						=> $this->input->post('options',true),			);						$this->form_validation->set_rules('machine_id', 'Machine', 'required');						if($this->form_validation->run()==true){				if($data[options]=="today"){					$data[start_date]=date("d-m-Y");					$data[end_date]=date("d-m-Y");					$this->session->set_userdata('filter-attendance',$data);					redirect('pulldataattendance');				}else if($data[options]=="thismonth"){					$data[start_date]=date("01-m-Y");					$data[end_date]=date("t-m-Y");;					$this->session->set_userdata('filter-attendance',$data);					redirect('pulldataattendance');				}else if($data[options]=="period"){					$this->session->set_userdata('filter-attendance',$data);					redirect('pulldataattendance');				}			}else{				$msg = validation_errors("<div class='alert alert-danger'>", "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'></button></div> ");				$this->session->set_userdata('message',$msg);				redirect('pulldataattendance');			}		}				public function resetfilter(){			$this->session->unset_userdata('filter-attendance');			$this->session->unset_userdata('dataattendance');			redirect('pulldataattendance');		}				function lists(){			$sesi	= 	$this->session->userdata('filter-attendance');			if(!is_array($sesi)){					$sesi['machine_id']						='';					$sesi['start_date']						='';					$sesi['end_date']						='';					$sesi['options']						='';			}else{				if($this->session->userdata("dataattendance")==""){					$machine_id = $this->uri->segment(3);					echo $machine_id;					$machine_info = $this->pulldataattendance_model->getmachineinfo($machine_id);					$zk = new ZKLib($machine_info[machine_ip_address],$machine_info[machine_port]);					$ret = $zk->connect();					$attendance = $zk->getAttendance();					$zk->disconnect();					// while( list($idx, $attendancedata) = each($attendance) ) {					// print_r($attendance);exit;					foreach($attendance as $key=>$val){						// print_r($val);exit;						$tglsplit = explode(" ",$val[3]);												// $konversi1 = date("Y-m-d", strtotime($val[3]));						$konversi1 = $tglsplit[0];						$tanggal_mesin = strtotime($konversi1);						$konversi2 = date("Y-m-d", strtotime($sesi['start_date']));						$start_date = strtotime($konversi2);						$konversi3 = date("Y-m-d", strtotime($sesi['end_date']));						$end_date = strtotime($konversi3);												if($tanggal_mesin >= $start_date && $tanggal_mesin <= $end_date){														// echo $val[3].' '.$konversi1." ".$konversi2." ".$konversi3;exit;														$data_item = array(												'index' => $key,												'id' 	=> $val[1],												'status' 	=> $val[2],												'tanggal' 	=> date("d-m-Y", strtotime($val[3])),												'jam' 	=> date("H:i:s", strtotime($val[3])),															);							$dataArray 	= $this->session->userdata("dataattendance");							$dataArray[$data_item['index']] = $data_item;							$this->session->set_userdata("dataattendance",$dataArray);														$attendance_employee_id = $this->pulldataattendance_model->getattendanceemployeeid($sesi['machine_id'],$val[1]);														// print_r($attendance_employee_id);exit;							$date = date("Y-m-d", strtotime($val[3]));							$time = date("H:i:s", strtotime($val[3]));							// if($this->pulldataattendance_model->checkifexistbyindex($attendance_employee_id,$key)==false){							if($this->pulldataattendance_model->checkifexistbydatetime($attendance_employee_id,$date,$time)==false){								$data_insert = array(												'attendance_employee_id' 	=> $attendance_employee_id,												// 'index' 					=> $key,												'date' 						=> date("Y-m-d", strtotime($val[3])),												'time' 						=> date("H:i:s", strtotime($val[3])),												'status' 					=> $val[2],												'verified' 					=> '0',								);								if($this->pulldataattendance_model->insertdata($data_insert)){									$msg = "<div class='alert alert-success'>												Attendance Data Updated											<button type='button' class='close' data-dismiss='alert' aria-hidden='true'></button></div> ";									$this->session->set_userdata('message',$msg);								}							}						}					}				}			}			$data['main_view']['machine']		= create_double($this->pulldataattendance_model->getmachine(),"machine_id","machine_name");			$data['main_view']['content']		= 'pulldataattendance/filterattendance_view';			$this->load->view('mainpage_view',$data);		}		}